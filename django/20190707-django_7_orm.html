<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="https://fonts.loli.net/css?family=Noto+Serif+SC:400,500,700&display=swap&subset=chinese-simplified" rel="stylesheet"><link href="https://fonts.loli.net/css?family=Parisienne" rel="stylesheet"><link href="https://fonts.loli.net/css?family=Pinyon+Script" rel="stylesheet"><link href="https://fonts.loli.net/css?family=EB+Garamond:400,500,700" rel="stylesheet"><link href="https://fonts.loli.net/css?family=Source+Code+Pro:400,700" rel="stylesheet"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="django,学习笔记,Web前端,"><meta name="description" content="本篇介绍Django的ORM。"><meta name="keywords" content="django,学习笔记,Web前端"><meta property="og:type" content="article"><meta property="og:title" content="Django的ORM"><meta property="og:url" content="https://chennq.com/django/20190707-django_7_orm.html"><meta property="og:site_name" content="Naqin"><meta property="og:description" content="本篇介绍Django的ORM。"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://chennq.com/django/20190707-django_7_orm/ORM.png"><meta property="og:updated_time" content="2019-11-15T11:07:15.009Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Django的ORM"><meta name="twitter:description" content="本篇介绍Django的ORM。"><meta name="twitter:image" content="https://chennq.com/django/20190707-django_7_orm/ORM.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"5.1.4",sidebar:{position:"left",display:"hide",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1,dimmer:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!0,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://chennq.com/django/20190707-django_7_orm.html"><title>Django的ORM | Naqin</title><meta name="baidu-site-verification" content="rqAw8UHNKS"><meta name="google-site-verification" content="r_iyjm0f8KcvC9kIpQiyZx3pmWlLY-gwBv9KsOF2AYo"></head><body itemscope itemtype="https://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="https://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Naqin</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Run! Forest,run!</h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section">首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section">关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section">标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section">分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section">归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger">搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="https://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://chennq.com/django/20190707-django_7_orm.html"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Naqin"><meta itemprop="description" content><meta itemprop="image" content="/uploads/tu6.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Naqin"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Django的ORM</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-07T21:16:54+08:00">2019-07-07 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a></span></span><div class="post-wordcount"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">9.2k 字</span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote class="blockquote-center"><p>本篇介绍Django的ORM。</p></blockquote><a id="more"></a><p>通过这篇文章，你能了解到：</p><ul><li>ORM是什么以及它的优缺点</li><li>ORM语句的使用</li></ul><h1 id="ORM"><a href="#ORM" class="headerlink" title="ORM"></a>ORM</h1><h2 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h2><ul><li><p>对象关系映射（Object Relational Mapping，简称ORM）模式是一种为了解决面向对象与关系数据库存在的互不匹配的现象的技术。</p></li><li><p>Django的orm操作本质上会根据对接的数据库引擎，翻译成对应的sql语句；所有使用Django开发的项目无需关心程序底层使用的是MySQL、Oracle、sqlite….，如果数据库迁移，只需要更换Django的数据库引擎即可。</p></li></ul><p><img src="/django/20190707-django_7_orm/ORM.png" alt="ORM"></p><h2 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h2><p>使用 ORM 最大的优点就是快速开发，让我们将更多的精力放在业务上而不是数据库上，下面是 ORM 的几个优点</p><ul><li>隐藏了数据访问细节，使通用数据库交互变得简单易行。同时 ORM 避免了不规范、冗余、风格不统一的 SQL 语句，可以避免很多人为的 bug，方便编码风格的统一和后期维护。</li><li>ORM提供了对数据库的映射，不用直接编写SQL代码，只需操作对象就能对数据库操作数据。</li><li>方便数据库的迁移。当需要迁移到新的数据库时，不需要修改对象模型，只需要修改数据库的配置。</li></ul><h2 id="劣势"><a href="#劣势" class="headerlink" title="劣势"></a>劣势</h2><p>ORM 的最令人诟病的地方就是<strong>性能</strong>问题，不过现在已经提高了很多，下面是 ORM 的几个缺点</p><ul><li>性能问题<ul><li>自动化进行数据库关系的映射需要消耗系统资源</li><li>程序员编码</li><li>在处理多表联查、where 条件复杂的查询时，ORM 可能会生成的效率低下的 SQL</li><li>通过 Lazy load 和 Cache 很大程度上改善了性能问题</li></ul></li><li>SQL 调优，SQL 语句是由 ORM 框架自动生成，虽然减少了 SQL 语句错误的发生，但是也给 SQL 调优带来了困难。</li><li>越是功能强大的 ORM 越消耗内存，因为一个 ORM Object 会带有很多成员变量和成员函数。</li><li>对象和关系之间并不是完美映射</li></ul><p>一般来说 ORM 足以满足我们的需求，如果对性能要求特别高或者查询十分复杂，可以考虑使用原生 SQL 和 ORM 共用的方式</p><h2 id="Django的ORM"><a href="#Django的ORM" class="headerlink" title="Django的ORM"></a>Django的ORM</h2><ul><li><p>Django ORM用到三个类：<code>Manager</code>、<code>QuerySet</code>、<code>Model</code>。</p></li><li><p>Manager定义表级方法（表级方法就是影响一条或多条记录的方法），我们可以以<code>models.Manager</code> 为父类，定义自己的manager，增加表级方法；</p></li><li><p>QuerySet：Manager类的一些方法会返回QuerySet实例，QuerySet是一个可遍历结构，包含一个或多个元素，每个元素都是一个Model 实例，它里面的方法也是表级方法，前面说了，Django给我们提供了增加表级方法的途径，那就是自定义manager类，而不是自定义QuerySet类，一般的我们没有自定义QuerySet类的必要；</p></li><li><p>Manager类的绝大部分方法是基于Queryset的。一个QuerySet包含一个或多个model instance。QuerySet类似于Python中的list，list的一些方法QuerySet也有，比如切片，遍历。</p></li><li><p>django.db.models模块中的Model类，我们定义表的model时，就是继承它，它的功能很强大，通过自定义model的instance可以获取外键实体等，它的方法都是记录级方法（都是实例方法，貌似无类方法），不要在里面定义类方法，比如计算记录的总数，查看所有记录，这些应该放在自定义的manager类中。</p></li></ul><h2 id="测试方式"><a href="#测试方式" class="headerlink" title="测试方式"></a>测试方式</h2><p>以前，我们不能直接运行一个py文件，因为会有环境约束，那我们还想在这个环境下，直接一段代码该怎么办？</p><h3 id="console控制台"><a href="#console控制台" class="headerlink" title="console控制台"></a>console控制台</h3><p>在django项目中，点击Python Console，就可以使用Django环境。</p><ul><li>优点：无需额外创建py文件</li><li>缺点：结果无法保存</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Python <span class="number">3.6</span><span class="number">.5</span> (v3<span class="number">.6</span><span class="number">.5</span>:f59c0932b4, Mar <span class="number">28</span> <span class="number">2018</span>, <span class="number">17</span>:<span class="number">00</span>:<span class="number">18</span>) [MSC v<span class="number">.1900</span> <span class="number">64</span> bit (AMD64)] on win32</span><br><span class="line">Django <span class="number">1.11</span><span class="number">.23</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> app01 <span class="keyword">import</span> models</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>models.Publisher.objects.all()</span><br></pre></td></tr></table></figure><h3 id="自定义py文件"><a href="#自定义py文件" class="headerlink" title="自定义py文件"></a>自定义py文件</h3><p>在django项目下自定义一个py文件，写入如下内容，就可以在django环境下使用。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.environ.setdefault(<span class="string">"DJANGO_SETTINGS_MODULE"</span>, <span class="string">"about_orm.settings"</span>)</span><br><span class="line"><span class="keyword">import</span> django</span><br><span class="line">django.setup()</span><br></pre></td></tr></table></figure><h3 id="admin管理后台"><a href="#admin管理后台" class="headerlink" title="admin管理后台"></a>admin管理后台</h3><p>可以使用的原因：</p><ul><li>url中有，而且在apps中也注册了</li></ul><p>对表进行增删查改</p><ol><li><p>创建超级用户</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage<span class="selector-class">.py</span> createsuperuser</span><br></pre></td></tr></table></figure><ul><li>然后，输入用户名密码</li></ul></li><li><p>注册</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app下的admin.py</span></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line">admin.site.register(models.Person)</span><br><span class="line"><span class="comment"># 注册了多个model，当编辑这个model是需要其它model（外键，多对多），但其它model内容为空就可以从当前页面打开创建其它model。</span></span><br></pre></td></tr></table></figure></li><li><p>登录</p><ul><li>127.0.0.1:8000/admin</li></ul></li><li><p>对于ManyToManyField字段 ，想避过admin校验（必填），可以加 <code>blank = True</code></p></li></ol><p>定制额外的功能</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> rbac <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Register your models here.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PermissionAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'title'</span>, <span class="string">'url'</span>, <span class="string">'is_menu'</span>, <span class="string">'icon'</span>]</span><br><span class="line">    list_editable = [<span class="string">'title'</span>, <span class="string">'url'</span>, <span class="string">'is_menu'</span>, <span class="string">'icon'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">admin.site.register(models.Role)</span><br><span class="line">admin.site.register(models.Permission, PermissionAdmin)</span><br><span class="line">admin.site.register(models.User)</span><br><span class="line"></span><br><span class="line">但是这样运行的时候出现了如下错误：</span><br><span class="line">ERRORS:</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">rbac</span>.<span class="title">admin</span>.<span class="title">PermissionAdmin</span>'&gt;:</span> (admin.E124) The value of <span class="string">'list_editable[0]'</span> refers to the first field <span class="keyword">in</span> <span class="string">'list_display'</span> (<span class="string">'title'</span>), which cannot be used unless <span class="string">'list_display_links'</span> <span class="keyword">is</span> set.</span><br><span class="line">解决方法如下：</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PermissionAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'title'</span>, <span class="string">'url'</span>, <span class="string">'is_menu'</span>, <span class="string">'icon'</span>]</span><br><span class="line">    <span class="comment"># list_editable = ['title','url', 'is_menu', 'icon', ]</span></span><br><span class="line">    list_editable = list_display</span><br><span class="line">    list_display_links = <span class="literal">None</span></span><br><span class="line">设置 list_display_links 就好</span><br></pre></td></tr></table></figure><h3 id="打印sql语句"><a href="#打印sql语句" class="headerlink" title="打印sql语句"></a>打印sql语句</h3><p>在settings.py中，添加如下配置，即可在使用orm查询数据库的时候，输出对应的sql语句。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">LOGGING = &#123;</span><br><span class="line">    <span class="string">'version'</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">'disable_existing_loggers'</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">'handlers'</span>: &#123;</span><br><span class="line">        <span class="string">'console'</span>:&#123;</span><br><span class="line">            <span class="string">'level'</span>:<span class="string">'DEBUG'</span>,</span><br><span class="line">            <span class="string">'class'</span>:<span class="string">'logging.StreamHandler'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'loggers'</span>: &#123;</span><br><span class="line">        <span class="string">'django.db.backends'</span>: &#123;</span><br><span class="line">            <span class="string">'handlers'</span>: [<span class="string">'console'</span>],</span><br><span class="line">            <span class="string">'propagate'</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">'level'</span>:<span class="string">'DEBUG'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="字段"><a href="#字段" class="headerlink" title="字段"></a>字段</h1><h2 id="常用字段"><a href="#常用字段" class="headerlink" title="常用字段"></a>常用字段</h2><h3 id="数值"><a href="#数值" class="headerlink" title="数值"></a>数值</h3><p><u><strong>AutoField</strong></u>(Field)</p><ul><li><p>int自增列，必须填入参数 primary_key=True</p></li><li><p>一个model不能有两个AutoField</p></li></ul><p>BigAutoField(AutoField)</p><ul><li>bigint自增列，必须填入参数 primary_key=True</li></ul><p>note：当model中如果没有自增列，则自动会创建一个列名为id的列</p><p>SmallIntegerField(IntegerField):</p><ul><li>小整数 -32768 ～ 32767</li></ul><p>PositiveSmallIntegerField(PositiveIntegerRelDbTypeMixin, IntegerField)</p><ul><li>正小整数 0 ～ 32767</li></ul><p><strong><u>IntegerField</u></strong>(Field)</p><ul><li>整数列(有符号的) -2147483648 ～ 2147483647</li><li>不要用它来存手机号（char）</li></ul><p>PositiveIntegerField(PositiveIntegerRelDbTypeMixin, IntegerField)</p><ul><li>正整数 0 ～ 2147483647</li></ul><p>BigIntegerField(IntegerField):</p><pre><code>- 长整型(有符号的) -9223372036854775808 ～ 9223372036854775807</code></pre><p>FloatField(Field)</p><ul><li>浮点型</li></ul><p><u><strong>DecimalField</strong></u>(Field)</p><ul><li>10进制小数</li><li>参数：<br>max_digits，小数总长度<br>decimal_places，小数位长度</li></ul><p>BinaryField(Field)</p><ul><li>二进制类型</li></ul><h3 id="布尔值"><a href="#布尔值" class="headerlink" title="布尔值"></a>布尔值</h3><p><strong><u>BooleanField</u></strong>(Field)</p><ul><li>布尔值类型</li></ul><p>NullBooleanField(Field):</p><ul><li>可以为空的布尔值</li></ul><h3 id="字符"><a href="#字符" class="headerlink" title="字符"></a>字符</h3><p><strong><u>CharField</u></strong>(Field)</p><pre><code>- 字符类型
- 必须提供max_length参数， max_length表示字符长度</code></pre><p>TextField(Field)</p><ul><li>文本类型</li></ul><h3 id="时间"><a href="#时间" class="headerlink" title="时间"></a>时间</h3><p><strong><u>DateTimeField</u></strong>(DateField)</p><ul><li>日期+时间格式 <code>YYYY-MM-DD HH:MM[:ss[.uuuuuu]][TZ]</code></li><li>auto_now_add=True 只保存新增的那个时间</li><li>auto_now 保存新增和修改的时间</li></ul><p><u><strong>DateField</strong></u>(DateTimeCheckMixin, Field)</p><ul><li>日期格式 YYYY-MM-DD，相当于Python中的datetime.date的实例。</li><li>auto_now：每次修改时修改为当前日期时间。</li><li>auto_now_add：新创建对象时自动添加当前日期时间。</li></ul><p>note：<code>auto_now</code> 、<code>auto_now_add</code> 、<code>default</code> 是互斥的</p><p>TimeField(DateTimeCheckMixin, Field)</p><ul><li>时间格式 HH:MM[:ss[.uuuuuu]]</li></ul><p>DurationField(Field)</p><ul><li>长整数，时间间隔，数据库中按照bigint存储，ORM中获取的值为datetime.timedelta类型</li></ul><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>EmailField(CharField)：</p><ul><li>字符串类型，Django Admin以及ModelForm中提供验证机制</li></ul><p>IPAddressField(Field)</p><ul><li>字符串类型，Django Admin以及ModelForm中提供验证 IPV4 机制</li></ul><p>GenericIPAddressField(Field)</p><ul><li>字符串类型，Django Admin以及ModelForm中提供验证 Ipv4和Ipv6</li><li>参数：<br>protocol，用于指定Ipv4或Ipv6， ‘both’,”ipv4”,”ipv6”<br>unpack_ipv4， 如果指定为True，则输入::ffff:192.0.2.1时候，可解析为192.0.2.1，开启此功能，需要protocol=”both”</li></ul><p>URLField(CharField)</p><ul><li>字符串类型，Django Admin以及ModelForm中提供验证 URL</li></ul><p>SlugField(CharField)</p><ul><li>字符串类型，Django Admin以及ModelForm中提供验证支持 字母、数字、下划线、连接符（减号）</li></ul><p>CommaSeparatedIntegerField(CharField)</p><ul><li>字符串类型，格式必须为逗号分割的数字</li></ul><p>UUIDField(Field)</p><ul><li>字符串类型，Django Admin以及ModelForm中提供对UUID格式的验证</li></ul><p>FilePathField(Field)</p><ul><li>字符串，Django Admin以及ModelForm中提供读取文件夹下文件的功能</li><li>参数：<br>path, 文件夹路径<br>match=None, 正则匹配<br>recursive=False, 递归下面的文件夹<br>allow_files=True, 允许文件<br>allow_folders=False, 允许文件夹</li></ul><p>FileField(Field)</p><ul><li>字符串，路径保存在数据库，文件上传到指定目录</li><li>参数：<br>upload_to = “” 上传文件的保存路径<br>storage = None 存储组件，默认django.core.files.storage.FileSystemStorage</li></ul><p>ImageField(FileField)</p><ul><li>字符串，路径保存在数据库，文件上传到指定目录</li><li>参数：<br>upload_to = “” 上传文件的保存路径<br>storage = None 存储组件，默认django.core.files.storage.FileSystemStorage<br>width_field=None, 上传图片的高度保存的数据库字段名（字符串）<br>height_field=None 上传图片的宽度保存的数据库字段名（字符串）</li></ul><p>推荐阅读: <a href="https://docs.djangoproject.com/en/1.11/ref/models/fields/#field-types" target="_blank" rel="noopener">field-types</a></p><h2 id="自定义字段"><a href="#自定义字段" class="headerlink" title="自定义字段"></a>自定义字段</h2><p>例子：自定义char类型</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCharField</span><span class="params">(models.Field)</span>:</span></span><br><span class="line">    <span class="string">'''自定义char类型的字段'''</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,max_length, *args, **kwargs)</span>:</span></span><br><span class="line">        self.max_length = max_length</span><br><span class="line">        super().__init__(max_length=max_length, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">db_type</span><span class="params">(self, connection)</span>:</span></span><br><span class="line">        <span class="string">'''限定生成数据库表的字段类型为char，长度为max_length指定的值'''</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f'char(<span class="subst">&#123;self.max_length&#125;</span>)'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment"># 使用自定义char类型字段</span></span><br><span class="line">    phone = MyCharField(max_length=<span class="number">11</span>)</span><br></pre></td></tr></table></figure><h1 id="字段参数"><a href="#字段参数" class="headerlink" title="字段参数"></a>字段参数</h1><h2 id="常用参数"><a href="#常用参数" class="headerlink" title="常用参数"></a>常用参数</h2><p><strong>null</strong></p><ul><li>该字段可以为空</li></ul><p><strong>blank</strong></p><ul><li>设置字段后，使用admin管理的表中该字段可以不填</li><li>校验时可以为空（使用admin管理的表中可以不填）</li></ul><p>default</p><ul><li>数据库中字段的默认值</li></ul><p><strong>primary_key</strong></p><ul><li>数据库中字段是否为主键</li></ul><p>db_index</p><ul><li>数据库中字段是否可以建立索引</li></ul><p>unique</p><ul><li>数据库中字段是否可以建立唯一索引</li></ul><p>unique_for_date</p><ul><li>数据库中字段【日期】部分是否可以建立唯一索引</li></ul><p>unique_for_month</p><ul><li>数据库中字段【月】部分是否可以建立唯一索引</li></ul><p>unique_for_year</p><ul><li>数据库中字段【年】部分是否可以建立唯一索引</li></ul><h2 id="model-form-系列"><a href="#model-form-系列" class="headerlink" title="model form 系列"></a>model form 系列</h2><p>verbose_name</p><ul><li>Admin中显示的字段名称</li></ul><p>blank</p><ul><li>Admin中是否允许用户输入为空</li></ul><p>editable</p><ul><li>Admin中是否可以编辑</li></ul><p>help_text</p><ul><li>Admin中该字段的提示信息</li></ul><p><strong><u>choices</u></strong></p><ul><li><p>Admin中显示选择框的内容，用不变动的数据放在内存中从而避免跨表操作</p></li><li><p>例子：</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 元组中，左边是真实存放的值，右边是显示的值</span></span><br><span class="line">gender = models.IntegerField(choices=[(<span class="number">0</span>, <span class="string">'男'</span>), (<span class="number">1</span>, <span class="string">'女'</span>)])</span><br></pre></td></tr></table></figure><p>对于choices字段：</p><p><code>对象.get_字段名_display()</code> 来显示对应的值，而不是数据库中的值</p><p>error_messages</p><ul><li>自定义错误信息（字典类型），从而定制想要显示的错误信息；</li><li>字典健：null, blank, invalid, invalid_choice, unique, and unique_for_date</li><li>如：{‘null’: “不能为空.”, ‘invalid’: ‘格式错误’}</li></ul><p>validators</p><ul><li>自定义错误验证（列表类型），从而定制想要的验证规则</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core.validators <span class="keyword">import</span> RegexValidator</span><br><span class="line"><span class="keyword">from</span> django.core.validators <span class="keyword">import</span> EmailValidator, URLValidator, DecimalValidator, MaxLengthValidator, MinLengthValidator, MaxValueValidator, MinValueValidator</span><br><span class="line">    <span class="comment"># 如：</span></span><br><span class="line">test = models.CharField(</span><br><span class="line">    max_length=<span class="number">32</span>,</span><br><span class="line">    error_messages=&#123;</span><br><span class="line">        <span class="string">'c1'</span>: <span class="string">'优先错信息1'</span>,</span><br><span class="line">        <span class="string">'c2'</span>: <span class="string">'优先错信息2'</span>,</span><br><span class="line">        <span class="string">'c3'</span>: <span class="string">'优先错信息3'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    validators=[</span><br><span class="line">        RegexValidator(regex=<span class="string">'root_\d+'</span>, message=<span class="string">'错误了'</span>, code=<span class="string">'c1'</span>),</span><br><span class="line">        RegexValidator(regex=<span class="string">'root_112233\d+'</span>, message=<span class="string">'又错误了'</span>, code=<span class="string">'c2'</span>),</span><br><span class="line">        EmailValidator(message=<span class="string">'又错误了'</span>, code=<span class="string">'c3'</span>), ]</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><p>推荐阅读 <a href="https://docs.djangoproject.com/en/1.11/ref/models/fields/#field-options" target="_blank" rel="noopener">field-options</a></p><h2 id="Model-Meta参数"><a href="#Model-Meta参数" class="headerlink" title="Model Meta参数"></a>Model Meta参数</h2><p>推荐阅读 <a href="https://docs.djangoproject.com/en/1.11/ref/models/options/#model-meta-options" target="_blank" rel="noopener">model meta options</a></p><ul><li><p>改变Admin中显示的内容：</p></li><li><p>改表名，显示名称</p></li><li><p>联合索引</p></li><li><p>联合唯一索引</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    pid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)  <span class="comment"># 旧版本按字节  varchar(32)</span></span><br><span class="line">    age = models.IntegerField(null=<span class="literal">True</span>, blank=<span class="literal">True</span>)</span><br><span class="line">    birth = models.DateTimeField(auto_now=<span class="literal">True</span>, null=<span class="literal">True</span>)</span><br><span class="line">    gender = models.IntegerField(choices=[(<span class="number">0</span>, <span class="string">'男'</span>), (<span class="number">1</span>, <span class="string">'女'</span>)])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># 数据库中生成的表名称 默认 app名称 + 下划线 + 类名</span></span><br><span class="line">        db_table = <span class="string">"app01_person"</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># admin中显示的表名称</span></span><br><span class="line">        verbose_name = <span class="string">'个人信息'</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># verbose_name加s</span></span><br><span class="line">        verbose_name_plural = <span class="string">'所有用户信息'</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 联合索引</span></span><br><span class="line">        index_together = [</span><br><span class="line">            (<span class="string">"name"</span>, <span class="string">"age"</span>),  <span class="comment"># 应为两个存在的字段</span></span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 联合唯一索引</span></span><br><span class="line">        unique_together = ((<span class="string">"name"</span>, <span class="string">"phone"</span>),)  <span class="comment"># 应为两个存在的字段</span></span><br></pre></td></tr></table></figure><p>当我们在settings.py 设置</p><p>LANGUAGE_CODE= ‘zh-Hans’</p><p>Admin 内的内容就翻译成中文了</p><h1 id="Manager"><a href="#Manager" class="headerlink" title="Manager"></a>Manager</h1><ul><li>在创建完 Model 对象之后，Django 会自动为其关联一个 <strong>Manager 对象</strong>，该对象是 Model <strong>进行数据库操作的接口</strong>。默认的 Manager 对象名称为 objects。</li><li>表级</li><li>Manager 对象也可以自定义。</li></ul><h2 id="更改Manager对象的名称"><a href="#更改Manager对象的名称" class="headerlink" title="更改Manager对象的名称"></a>更改Manager对象的名称</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># models.py</span></span><br><span class="line"><span class="comment"># 更改Manager对象的名称</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    people = models.Manager()</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义的py文件中</span></span><br><span class="line">ret = models.Person.people.all()</span><br><span class="line">print(ret)</span><br></pre></td></tr></table></figure><h2 id="自定义Manager对象"><a href="#自定义Manager对象" class="headerlink" title="自定义Manager对象"></a>自定义Manager对象</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># models.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewManager</span><span class="params">(models.Manager)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(self, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">from</span> django.db <span class="keyword">import</span> connection</span><br><span class="line">        cursor = connection.cursor()</span><br><span class="line">        condition = <span class="string">''</span></span><br><span class="line">        <span class="keyword">if</span> kwargs.get(<span class="string">'pid'</span>, <span class="literal">None</span>):</span><br><span class="line">            condition = <span class="string">f"a.pid = <span class="subst">&#123;kwargs[<span class="string">'pid'</span>]&#125;</span> and"</span></span><br><span class="line">        query = <span class="string">f'''</span></span><br><span class="line"><span class="string">                    SELECT a.name,a.age </span></span><br><span class="line"><span class="string">                    FROM app01_person a WHERE <span class="subst">&#123;condition&#125;</span> TRUE</span></span><br><span class="line"><span class="string">                    GROUP BY a.pid</span></span><br><span class="line"><span class="string">                '''</span></span><br><span class="line">        <span class="comment"># print(query)</span></span><br><span class="line">        cursor.execute(query)</span><br><span class="line">        result_list = cursor.fetchall()</span><br><span class="line">        res = []</span><br><span class="line">        <span class="keyword">for</span> i,j <span class="keyword">in</span> result_list:</span><br><span class="line">            res.append(<span class="string">f"<span class="subst">&#123;i&#125;</span>今年<span class="subst">&#123;j&#125;</span>岁"</span>)</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment"># people = models.Manager()</span></span><br><span class="line">    people = NewManager()   <span class="comment"># 实例化自定义Manager对象</span></span><br><span class="line">    pid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)  <span class="comment"># 旧版本按字节  varchar(32)</span></span><br><span class="line">    age = models.IntegerField(null=<span class="literal">True</span>, blank=<span class="literal">True</span>)</span><br><span class="line">    birth = models.DateTimeField(auto_now=<span class="literal">True</span>, null=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f'<span class="subst">&#123;self.pk&#125;</span> <span class="subst">&#123;self.name&#125;</span>'</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义的py文件中</span></span><br><span class="line">ret = models.Person.people.func()</span><br><span class="line">ret = models.Person.people.func(pid=<span class="number">1</span>)</span><br><span class="line">print(ret)</span><br></pre></td></tr></table></figure><h1 id="QuerySet"><a href="#QuerySet" class="headerlink" title="QuerySet"></a>QuerySet</h1><ul><li>从数据库中查询出来的结果一般是一个集合，这个集合称为 QuerySet。</li><li>QuerySet 有两种来源：通过 Manager 的方法获取、通过 QuerySet 自身的方法获得。</li><li>字段级</li><li>Manager 的查询方法和 QuerySet 的方法大部分同名、同意（Manager的就是基于 QuerySet 的实现的，所有两者会有相同的部分），例如 相同的有：filter, exclude等，但两者也有不同的方法，例如 Manager 的 create、get_or_create，QuerySet 的 delete 等。</li></ul><h2 id="限制QuerySet"><a href="#限制QuerySet" class="headerlink" title="限制QuerySet"></a>限制QuerySet</h2><p>在MySQL查询时，我们往往可以限制显示的数量， <code>LIMIT</code>，那再ORM中是如何表达呢? 切片！！！</p><p>对于QuerySet，我们可以时候python中的索引，切片，来限制输出，一个场景就是用于分页。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示前3个元素</span></span><br><span class="line">ret = models.Person.objects.all()[:<span class="number">3</span>]</span><br><span class="line">print(ret)</span><br></pre></td></tr></table></figure><ul><li>看到这里可能会有一个疑惑，这有些low吧。查了所有，然后只显示前3个，其实并不是这样的，因为有Lazy load机制。</li></ul><h2 id="Lazy-load"><a href="#Lazy-load" class="headerlink" title="Lazy load"></a>Lazy load</h2><p>QuerySet 是惰性加载的，创建查询集不会访问数据库，只有查询集需要<strong>求值</strong>时，才会真正运行这个查询。</p><p>在下面的例子中只有执行 <code>print ret</code> 才会真正的去查询数据库。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ret = models.Person.objects.all()</span><br><span class="line">print(ret)</span><br></pre></td></tr></table></figure><p>关联对象也是惰性加载，只有用到了关联对象的值才会访问数据库</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ret = models.Person.objects.get(pk=<span class="number">1</span>)</span><br><span class="line">print(ret)</span><br></pre></td></tr></table></figure><p>真正访问数据库的几种情况：</p><ul><li>迭代：在首次迭代查询集时会执行数据库查询</li><li>切片(限制查询集)：对查询集执行切片操作时或指定 step 参数</li><li>序列化／缓存</li><li>repr：对查询集调用 repr 函数</li><li>len：对查询集调用 len 函数</li><li>list: 对查询集调用 list() 方法强制求值</li><li>bool:测试一个查询集的布尔值，例如使用bool(), or, and 或者 if 语句都将导致查询集的求值</li></ul><h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p>每个 QuerySet 都包含一个缓存来最小化对数据库的访问</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 访问两次数据库</span></span><br><span class="line">print([obj.name <span class="keyword">for</span> obj <span class="keyword">in</span> models.Person.objects.all()])</span><br><span class="line">print([obj.age <span class="keyword">for</span> obj <span class="keyword">in</span> models.Person.objects.all()])</span><br><span class="line"><span class="comment"># 访问一次数据库</span></span><br><span class="line">ret = models.Person.objects.all()</span><br><span class="line">print([obj.name <span class="keyword">for</span> obj <span class="keyword">in</span> ret])</span><br><span class="line">print([obj.age <span class="keyword">for</span> obj <span class="keyword">in</span> ret])</span><br></pre></td></tr></table></figure><ul><li><p>在一个新的 QuerySet 中，缓存为空。当首次对 QuerySet 的所有实例进行求值时（代码中是print），会将查询结果保存到 QuerySet 的缓冲中。</p></li><li><p>当再访问该 QuerySet 时，会直接从缓冲中取数据。</p></li></ul><h1 id="必知必会13条（查询）"><a href="#必知必会13条（查询）" class="headerlink" title="必知必会13条（查询）"></a>必知必会13条（查询）</h1><h2 id="返回QuerySet"><a href="#返回QuerySet" class="headerlink" title="返回QuerySet"></a>返回<code>QuerySet</code></h2><p><strong>8 个</strong></p><ul><li>all</li><li>filter</li><li>exclude</li><li>values</li><li>values_list</li><li>order_by</li><li>reverse</li><li>distinct</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1. all 获取所有数据，返回QuerySet（对象列表）</span></span><br><span class="line">ret = models.Person.objects.all()</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. filter 获取所有满足条件的数据，返回QuerySet（对象列表）</span></span><br><span class="line">ret = models.Person.objects.filter(pk=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. exclude 获取所有不满足条件的数据，返回QuerySet（对象列表）</span></span><br><span class="line">ret = models.Person.objects.exclude(pk=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#4. orderby  按照字段进行排序，返回QuerySet。默认升序，加 - 表示降序</span></span><br><span class="line">ret = models.Person.objects.all().order_by(<span class="string">'-pid'</span>)</span><br><span class="line"><span class="comment"># 还可以按多个字段进行排序，前面的字段相同则按照后面的字段排序</span></span><br><span class="line">ret = models.Person.objects.all().order_by(<span class="string">'age'</span>, <span class="string">'-pid'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#5. reverse 对已经排序的queryset进行翻转（只是结果反过来）。 要求:在排序过的，才能执行翻转;</span></span><br><span class="line">ret = models.Person.objects.all().order_by(<span class="string">'pid'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#6. values 获取对象的字段名和字段值。返回QuerySet，QuerySet中包含字典。没有参数表示所有字段; 有参数获取指定字段。</span></span><br><span class="line">ret = models.Person.objects.all().values()</span><br><span class="line"><span class="comment"># ret = models.Person.objects.all().values('pid')</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#7. values_list 获取对象的字段值，返回QuerySet，QuerySet中包含元组。  没有参数时指所有字段；按顺序设置字段得到对应顺序的字段值。</span></span><br><span class="line">ret = models.Person.objects.all().values_list()</span><br><span class="line">ret = models.Person.objects.all().values_list(<span class="string">'name'</span>,<span class="string">'pid'</span>)</span><br><span class="line">ret = models.Person.objects.all().values_list(<span class="string">'pid'</span>,<span class="string">'name'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#8.  distict 按照元素去重，如果元素是对象的话，需对象一样才能去重。不能直接按字段去重</span></span><br><span class="line">ret = models.Person.objects.all().distinct()</span><br><span class="line">	<span class="comment"># 按指定字段去重 </span></span><br><span class="line">ret = models.Person.objects.values(<span class="string">'age'</span>).distinct()</span><br></pre></td></tr></table></figure><h2 id="返回对象"><a href="#返回对象" class="headerlink" title="返回对象"></a>返回对象</h2><p><strong>3个</strong></p><ul><li>get</li><li>first</li><li>last</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get 获取一个满足条件的数据,返回对象  要求:存在且唯一,其它情况报错</span></span><br><span class="line">ret = models.Person.objects.get(pk=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># first 获取第一个元素，如果不存在返回None</span></span><br><span class="line">ret = models.Person.objects.filter(pk=<span class="number">100</span>).first()</span><br><span class="line">ret = models.Person.objects.filter(pk=<span class="number">1</span>).first()</span><br><span class="line"></span><br><span class="line"><span class="comment"># last 获取最后一个元素，如果不存在返回None</span></span><br><span class="line">ret = models.Person.objects.filter(pk=<span class="number">100</span>).last()</span><br><span class="line">ret = models.Person.objects.filter(pk=<span class="number">1</span>).last()</span><br></pre></td></tr></table></figure><h2 id="返回bool"><a href="#返回bool" class="headerlink" title="返回bool"></a>返回bool</h2><ul><li>exists</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exists  判断数据是否存在,存在这条记录，返回True,否则返回False</span></span><br><span class="line">ret = models.Person.objects.filter(pk=<span class="number">1</span>).exists()</span><br></pre></td></tr></table></figure><h2 id="返回数字"><a href="#返回数字" class="headerlink" title="返回数字"></a>返回数字</h2><ul><li>count</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># count 计数,比len的效率高一些，因为len会真正的去数据库中进行查询</span></span><br><span class="line">ret = models.Person.objects.all().count()</span><br><span class="line">print(len(models.Person.objects.all()))</span><br></pre></td></tr></table></figure><h1 id="单表的双下划线"><a href="#单表的双下划线" class="headerlink" title="单表的双下划线"></a>单表的双下划线</h1><p>双下划线是python的一个特色，在ORM中通常用于显式分隔<strong>过滤关键字</strong> (filter key name) 的各个部分。在底层，字符串用这些下划线分割开，然后这些标记分开处理。<code>name__contains</code> 被替换成 <code>attribute: name, filter: contains</code>。</p><h2 id="范围"><a href="#范围" class="headerlink" title="范围"></a>范围</h2><h3 id="大于，大于等于，小于，小于等于"><a href="#大于，大于等于，小于，小于等于" class="headerlink" title="大于，大于等于，小于，小于等于"></a>大于，大于等于，小于，小于等于</h3><ul><li><code>__gt</code></li><li><code>__gte</code></li><li><code>__lt</code></li><li><code>__lte</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ret = models.Person.objects.filter(pk__gt=<span class="number">1</span>)  <span class="comment"># greater than</span></span><br><span class="line">ret = models.Person.objects.filter(pk__gte=<span class="number">1</span>)  <span class="comment"># greater than equal</span></span><br><span class="line">ret = models.Person.objects.filter(pk__lt=<span class="number">1</span>)  <span class="comment"># less than</span></span><br><span class="line">ret = models.Person.objects.filter(pk__lte=<span class="number">1</span>)  <span class="comment"># less than equal</span></span><br><span class="line">ret = models.Person.objects.filter(pk=<span class="number">1</span>)  <span class="comment"># equal</span></span><br></pre></td></tr></table></figure><h3 id="具体区间"><a href="#具体区间" class="headerlink" title="具体区间"></a>具体区间</h3><p>（闭区间）</p><ul><li><code>__range</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret = models.Person.objects.filter(pk__range=[<span class="number">1</span>, <span class="number">3</span>])  <span class="comment"># 表示范围</span></span><br></pre></td></tr></table></figure><h3 id="成员判断"><a href="#成员判断" class="headerlink" title="成员判断"></a>成员判断</h3><ul><li><code>__in</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret = models.Person.objects.filter(pk__in=[<span class="number">1</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">9</span>])  <span class="comment"># 取出这几个</span></span><br></pre></td></tr></table></figure><h2 id="模糊查询"><a href="#模糊查询" class="headerlink" title="模糊查询"></a>模糊查询</h2><h3 id="包含"><a href="#包含" class="headerlink" title="包含"></a>包含</h3><ul><li><code>__contains</code></li><li><code>__icontains</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ret = models.Person.objects.filter(name__contains=<span class="string">'a'</span>)  <span class="comment"># like  包含/模糊查询</span></span><br><span class="line">ret = models.Person.objects.filter(name__icontains=<span class="string">'A'</span>)  <span class="comment"># like  包含/模糊查询  ignore 忽略大小写</span></span><br></pre></td></tr></table></figure><h3 id="以什么开头"><a href="#以什么开头" class="headerlink" title="以什么开头"></a>以什么开头</h3><ul><li><code>__startswith</code></li><li><code>__istartswith</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ret = models.Person.objects.filter(name__startswith=<span class="string">'x'</span>)  <span class="comment"># 以什么开头</span></span><br><span class="line">ret = models.Person.objects.filter(name__istartswith=<span class="string">'x'</span>)  <span class="comment"># 以什么开头  忽略大小写</span></span><br></pre></td></tr></table></figure><h3 id="以什么结尾"><a href="#以什么结尾" class="headerlink" title="以什么结尾"></a>以什么结尾</h3><ul><li><code>__endswith</code></li><li><code>__iendswith</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ret = models.Person.objects.filter(name__endswith=<span class="string">'x'</span>)  <span class="comment"># 以什么结尾</span></span><br><span class="line">ret = models.Person.objects.filter(name__iendswith=<span class="string">'X'</span>)  <span class="comment"># 以什么结尾  忽略大小写</span></span><br></pre></td></tr></table></figure><h3 id="年份"><a href="#年份" class="headerlink" title="年份"></a>年份</h3><ul><li><code>__year</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ret = models.Person.objects.filter(birth__year=<span class="number">2019</span>)  <span class="comment"># 查询年份是2019</span></span><br><span class="line">ret = models.Person.objects.filter(birth__month=<span class="number">9</span>)  <span class="comment"># 对于datetime是查不到的</span></span><br></pre></td></tr></table></figure><ul><li><code>__month</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret = models.Person.objects.filter(birth__month=<span class="number">9</span>) <span class="comment"># 对于date类型是可以查到的</span></span><br></pre></td></tr></table></figure><ul><li>使用模糊查询来查月份（会有警告，不过还是可以查到）</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ret = models.Person.objects.filter(birth__contains=<span class="number">9</span>)</span><br><span class="line">ret = models.Person.objects.filter(birth__contains=<span class="string">'2019-09'</span>)</span><br></pre></td></tr></table></figure><h3 id="为空"><a href="#为空" class="headerlink" title="为空"></a>为空</h3><ul><li><code>__isnull</code></li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret = models<span class="selector-class">.Person</span><span class="selector-class">.objects</span><span class="selector-class">.filter</span>(age__isnull=True)</span><br></pre></td></tr></table></figure><h1 id="外键的查询"><a href="#外键的查询" class="headerlink" title="外键的查询"></a>外键的查询</h1><h2 id="模型定义"><a href="#模型定义" class="headerlink" title="模型定义"></a>模型定义</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Publisher</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"<span class="subst">&#123;self.pk&#125;</span>  <span class="subst">&#123;self.name&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    pub = models.ForeignKey(to=<span class="string">'Publisher'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"<span class="subst">&#123;self.pk&#125;</span>  <span class="subst">&#123;self.title&#125;</span>"</span></span><br></pre></td></tr></table></figure><p>note：对于Book想要删除pub 只需要 Book.pub = None 就欧克了</p><h3 id="自关联"><a href="#自关联" class="headerlink" title="自关联"></a>自关联</h3><ul><li>表内自关联是指表内数据相关联的对象和表是相同字段，这样我们就直接用表内关联将外键关联设置成自身表的字段。同样表内关联也分一对多字段和多对多字段。</li></ul><h3 id="伪外键"><a href="#伪外键" class="headerlink" title="伪外键"></a>伪外键</h3><p>db_constraint = False 数据库中不加这个外键约束，相当于伪约束。</p><h2 id="基于对象的查询"><a href="#基于对象的查询" class="headerlink" title="基于对象的查询"></a>基于对象的查询</h2><p>基于对象的查询： 正向查询，反向查询</p><h3 id="不指定related-name"><a href="#不指定related-name" class="headerlink" title="不指定related_name"></a>不指定related_name</h3><ol><li>正向查询： 通过Book对象来查Publisher</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">book_obj = models.Book.objects.all().first()</span><br><span class="line">print(book_obj.pub)</span><br><span class="line">print(book_obj.pub_id)	</span><br><span class="line">print(book_obj.pub.name)	<span class="comment"># 非id的其它字段就只能连续 . 了</span></span><br></pre></td></tr></table></figure><ol start="2"><li>反向查询：通过Publisher对象来查询Book<ul><li>关系管理对象名称：类名小写 加 <code>_set</code></li></ul></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pub_obj = models.Publisher.objects.get(pk=<span class="number">1</span>)</span><br><span class="line">print(pub_obj.name)</span><br><span class="line">print(pub_obj.book_set,type(pub_obj.book_set))	<span class="comment"># 关系管理对象</span></span><br><span class="line">print(pub_obj.book_set.all())	<span class="comment"># 查询关联的所有对象</span></span><br></pre></td></tr></table></figure><h3 id="指定related-name"><a href="#指定related-name" class="headerlink" title="指定related_name"></a>指定related_name</h3><p>在外键字段中 添加 <code>related_name=&#39;book&#39;</code></p><ol><li>正向查询：通过Book对象来查Publisher<ul><li>同前面，略。</li></ul></li></ol><ol><li>反向查询：通过Publisher对象来查询Book<ul><li>不同之处在于，关系管理对象的名字</li><li>关系管理对象名称： <code>book</code></li></ul></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret = pub_obj.book.all()</span><br></pre></td></tr></table></figure><h2 id="基于字段的查询"><a href="#基于字段的查询" class="headerlink" title="基于字段的查询"></a>基于字段的查询</h2><h3 id="不指定related-name-1"><a href="#不指定related-name-1" class="headerlink" title="不指定related_name"></a>不指定related_name</h3><ol><li><p>给出版社的名字，查书籍（通过外键）</p><ul><li><p>pub__name表示从 book表跨到publisher</p></li><li><p>__ 表示跨表，在sql语句中，就是要进行连表操作。</p></li></ul></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">book = models.Book.objects.filter(pub__name=<span class="string">'变强出版社'</span>)</span><br><span class="line">print(book)</span><br></pre></td></tr></table></figure><ol start="2"><li><p>给书名查出版社</p><ul><li><p>Publisher对象 通过 book (类名小写) 来跨表</p></li><li><p>类名小写__字段</p></li></ul></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ret = models.Publisher.objects.filter(book__title=<span class="string">'Mysql删库到跑路'</span>)</span><br><span class="line">print(ret)</span><br></pre></td></tr></table></figure><h3 id="指定related-name-1"><a href="#指定related-name-1" class="headerlink" title="指定related_name"></a>指定related_name</h3><p>外键定义中添加 related_name=’books’</p><ol><li>给出版社的名字，查书籍（通过外键）<ul><li>同前面，不涉及related_name。</li></ul></li><li>给书名查出版社<ul><li>通过定义的 books 来进行跨表</li><li>关系管理对象名称：<code>books</code></li></ul></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ret = models.Publisher.objects.filter(books__title=<span class="string">'Mysql删库到跑路'</span>)</span><br><span class="line">print(ret)</span><br></pre></td></tr></table></figure><h3 id="指定related-query-name"><a href="#指定related-query-name" class="headerlink" title="指定related_query_name"></a>指定related_query_name</h3><p>外键定义中添加 related_query_name=’xxx’</p><ol><li>给出版社的名字，查书籍（通过外键）<ul><li>同前面，不涉及related_name。</li></ul></li><li>给书名查出版社<ul><li>通过定义的 xxx 来进行跨表</li><li>关系管理对象名称：xxx</li><li>且只能用在基于字段查询，不能用在基于对象查询</li></ul></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ret = models.Publisher.objects.filter(xxx__title=<span class="string">'Mysql删库到跑路'</span>)</span><br><span class="line">print(ret)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过对象是查不到的</span></span><br><span class="line">pub_obj = models.Publisher.objects.all().first()</span><br><span class="line">print(pub_obj.xxx)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 即使 写了related_name 参数，仍优先使用related_query_name</span></span><br></pre></td></tr></table></figure><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>​ 设置了外键后，我们可以通过外键来正向查询所关联的对象，名称为外键名（<code>pub =models.ForeignKey(to=&#39;Publisher&#39;)</code>），使用外键名与双下划线（<code>pub__</code>）就可以进行跨表查询，通过book对象，来查询出版社的信息。</p><p>​ 那么对于出版社来说，通过出版社对象查询书籍的过程被称为反向操作(没有设置外键/少的一方 —&gt;设置外键/多的一方)，具体如下：</p><ul><li>在没有指定related_name的时候，我们通过设置外键的那个类的类名小写与双下划线结合( <code>book__</code> )来进行跨表查询；</li><li>设置了 related_name 后，我们不再用类名小写，而是用 related_name 的值；</li><li>在基于字段查询的过程中，如果设置了related_query_name，则优先使用related_query_name的值。</li><li>所以 related_name 和 related_query_name 都是反向查询时，关系管理对象可用的名字</li></ul><h2 id="关系管理对象的方法"><a href="#关系管理对象的方法" class="headerlink" title="关系管理对象的方法"></a>关系管理对象的方法</h2><ul><li><p>通过关系管理对象来进行增删查改</p></li><li><p>针对出版社与书籍这个一对多关系</p></li></ul><p>all</p><ul><li>获取所关联的所有对象</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 正向</span></span><br><span class="line">book = models.Book.objects.all().first()</span><br><span class="line">print(book.pub)</span><br><span class="line"><span class="comment"># 反向</span></span><br><span class="line">publish = models.Publisher.objects.all().first()</span><br><span class="line">print(publish.book_set.all())</span><br></pre></td></tr></table></figure><p>set</p><ul><li><p>设置一对多关系</p></li><li><p>只能用对象或对象列表，不能用id</p></li><li><p>set(QuerySet)</p></li><li><p>当为外键设置 null=True 时，才可以减少（减少意味着，有些就为null了）；没有设置null=True 则不会改变。</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 正向 ： 一本书对应一个出版社</span></span><br><span class="line"><span class="comment"># 对于正向来说，pub是关联的对象，而不是关系管理对象，所以不能使用这些方法。</span></span><br><span class="line">book = models.Book.objects.all().first()</span><br><span class="line">print(book.pub) <span class="comment"># None</span></span><br><span class="line"><span class="comment"># book.pub.set(models.Publisher.objects.filter(pk=2))  # 报错， 当没有设置关联对象时，是没有set方法可以使用的。</span></span><br><span class="line">book.pub = models.Publisher.objects.filter(pk=<span class="number">2</span>).first()</span><br><span class="line">book.save()</span><br><span class="line">print(book.pub)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 反向 ：一个出版社可以对应很多书</span></span><br><span class="line">publish = models.Publisher.objects.all().first()</span><br><span class="line">print(publish.book_set.all())</span><br><span class="line">publish.book_set.set(models.Book.objects.filter(pk__in=[<span class="number">3</span>]))</span><br><span class="line">print(publish.book_set.all())</span><br></pre></td></tr></table></figure><p>add</p><ul><li><p>添加一对多关系</p></li><li><p>add(对象, 对象)</p></li><li><p>add( *QuerySet) 列表打散</p></li><li><p>理解上也是：我的少的一方可以指定多的一方（一个出版社可以对应很多书）</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 正向</span></span><br><span class="line">user_obj.customers.add(*models.Customer.objects.filter(pk__in=opt_cus))</span><br></pre></td></tr></table></figure><p>remove/clear</p><ul><li><p>remove(*QuerySet)</p></li><li><p>当你干掉这两个字段后，为null，如果字段不允许为空就会报错</p></li><li><p>外键字段设置可以为空 null=True 后，才能用remove/clear</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 反向：</span></span><br><span class="line">publish = models.Publisher.objects.all().first()</span><br><span class="line">print(publish.book_set.all())</span><br><span class="line">publish.book_set.clear()      <span class="comment"># 这一条</span></span><br><span class="line">print(publish.book_set.all())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正向</span></span><br><span class="line">user_obj.customers.remove(*models.Customer.objects.filter(pk__in=opt_cus))</span><br></pre></td></tr></table></figure><p>create</p><ul><li>新增一个所关联的对象，并且建立一对多的关系(少的一方创建多的一方)</li><li>小差别</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过关系管理对象，创建一本书。</span></span><br><span class="line">publish = models.Publisher.objects.all().first()</span><br><span class="line">publish.book_set.create(title=<span class="string">'祥龙宝典'</span>)</span><br><span class="line">print(publish.book_set.all())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这也会给别的出版社添加一本书</span></span><br><span class="line">publish = models.Publisher.objects.all().first()</span><br><span class="line">publish.book_set.create(title=<span class="string">'万象森罗'</span>,pub_id=<span class="number">3</span>)</span><br><span class="line">print(publish.book_set.all())</span><br></pre></td></tr></table></figure><p>update</p><ul><li>使用<code>update()</code>方法可以批量为QuerySet中所有的对象进行更新操作。</li><li>增加外键：</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 反向</span></span><br><span class="line">models.Customer.objects.filter(pk__in=opt_cus).update(consultant=user_obj)</span><br></pre></td></tr></table></figure><ul><li>删除外键：</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 反向</span></span><br><span class="line">models.Customer.objects.filter(pk__in=opt_cus).update(consultant=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure><h1 id="多对多关系"><a href="#多对多关系" class="headerlink" title="多对多关系"></a>多对多关系</h1><h2 id="模型定义-1"><a href="#模型定义-1" class="headerlink" title="模型定义"></a>模型定义</h2><p>继续在models.py 中定义新类 Author， Author 与 Book 是多对多关系。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Publisher</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"<span class="subst">&#123;self.pk&#125;</span>  <span class="subst">&#123;self.name&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    pub = models.ForeignKey(to=<span class="string">'Publisher'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"<span class="subst">&#123;self.pk&#125;</span>  <span class="subst">&#123;self.title&#125;</span>"</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Author</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    books = models.ManyToManyField(to=<span class="string">'Book'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"<span class="subst">&#123;self.pk&#125;</span>  <span class="subst">&#123;self.name&#125;</span>"</span></span><br></pre></td></tr></table></figure><h2 id="基于对象的查询-1"><a href="#基于对象的查询-1" class="headerlink" title="基于对象的查询"></a>基于对象的查询</h2><h3 id="不指定related-name-2"><a href="#不指定related-name-2" class="headerlink" title="不指定related_name"></a>不指定related_name</h3><ol><li>正向查询：</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">author = models.Author.objects.all().first()</span><br><span class="line">print(author.name)</span><br><span class="line">print(author.books,type(author.books))  <span class="comment"># 关系管理对象</span></span><br><span class="line">print(author.books.all())	<span class="comment"># 查询该作者关联的所有书籍</span></span><br></pre></td></tr></table></figure><ol start="2"><li>反向查询：<ul><li>关系管理对象名称：类名小写 加 <code>_set</code> （<code>author_set</code>）</li></ul></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">book_obj = models.Book.objects.all().first()</span><br><span class="line">print(book_obj)</span><br><span class="line">print(book_obj.author_set.all())	<span class="comment"># 查询该书关联的所有作者</span></span><br></pre></td></tr></table></figure><h3 id="指定related-name-2"><a href="#指定related-name-2" class="headerlink" title="指定related_name"></a>指定related_name</h3><ol><li>正向：<ul><li>相似，略。（不涉及related_name）</li></ul></li></ol><ol start="2"><li>反向查询：<ul><li>在ManyToManyField设置 related_name 为authors</li><li>关系管理对象名称： authors</li></ul></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">book_obj = models.Book.objects.all().first()</span><br><span class="line">print(book_obj)</span><br><span class="line">print(type(book_obj.authors))	<span class="comment"># 关系管理对象</span></span><br><span class="line">print(book_obj.authors.all())	<span class="comment"># 查询该书关联的所有作者</span></span><br></pre></td></tr></table></figure><h2 id="基于字段的查询-1"><a href="#基于字段的查询-1" class="headerlink" title="基于字段的查询"></a>基于字段的查询</h2><h3 id="不指定related-name-3"><a href="#不指定related-name-3" class="headerlink" title="不指定related_name"></a>不指定related_name</h3><ol><li><p>通过书籍去查作者</p><ul><li><p>正向查询（设置ManyToManyField）</p></li><li><p>Author —&gt; Book</p></li></ul></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">author = models.Author.objects.filter(books__title=<span class="string">'Mysql删库到跑路'</span>)</span><br><span class="line">print(author)</span><br></pre></td></tr></table></figure><ol start="2"><li>通过作者去查书籍<ul><li>查询这个作者写的书（反向查询）</li><li>Book —&gt; Author</li></ul></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">books = models.Book.objects.filter(author__name=<span class="string">'光头强'</span>)</span><br><span class="line">print(books)</span><br></pre></td></tr></table></figure><h3 id="指定related-name-3"><a href="#指定related-name-3" class="headerlink" title="指定related_name"></a>指定related_name</h3><p>在 ManyToManyField 定义中，添加 <code>related_name = &#39;authors&#39;</code></p><ol><li><p>通过书籍去查作者</p><ul><li>同前面， related_name 不影响正向</li></ul></li><li><p>通过作者去查书籍</p><ul><li>关系管理对象名称： authors</li></ul></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">books = models.Book.objects.filter(authors__name=<span class="string">'光头强'</span>)</span><br><span class="line">print(books)</span><br></pre></td></tr></table></figure><h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><p>基于对象的查询与基于字段的查询：</p><ul><li>基于字段的查询，名称是写在 filter 内部，当关键字参数；而基于对象的查询，是通过 <code>对象.关联对象小写__set</code> 这个关系管理对象来进行操作。</li></ul><h2 id="关系管理对象的方法-1"><a href="#关系管理对象的方法-1" class="headerlink" title="关系管理对象的方法"></a>关系管理对象的方法</h2><ul><li><p>通过关系管理对象来进行增删查改</p></li><li><p>针对书籍与作者这个多对多关系</p></li><li><p>也分为正反向，反向也可以使用 related_name , 明确用对的关系管理对象名称就行。</p></li></ul><p>all</p><ul><li>获取所关联的所有对象</li></ul><p>set</p><ul><li><p>设置多对多关系（先删除该对象原有的，在添加新的）</p></li><li><p>[id, id, id]</p></li><li><p>[对象, 对象, 对象] 或 QuerySet，最终还是转成id</p></li><li><p>为什么可以做到呢? 因为这个表里共三个字段，id不用管，book_id 是你当前对象携带的，所以只需要指定 author_id 就行。</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">book_obj = models.Book.objects.all().first()</span><br><span class="line">print(book_obj.authors.all())   <span class="comment"># 原来是&lt;QuerySet [&lt;Author: 1  光头强&gt;, &lt;Author: 2  小灰&gt;]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过id 修改</span></span><br><span class="line">book_obj.authors.set([<span class="number">2</span>,<span class="number">3</span>])     <span class="comment"># 通过Book对象，在 author_book表中，进行修改，先删除原来的关系，在添加新的关系</span></span><br><span class="line">print(book_obj.authors.all())   <span class="comment"># 改为&lt;QuerySet [&lt;Author: 2  小灰&gt;, &lt;Author: 3  小光&gt;]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 QuerySet 修改</span></span><br><span class="line">ret = book_obj.authors.set(models.Author.objects.filter(pk__in=[<span class="number">2</span>]))</span><br><span class="line">print(ret)	<span class="comment"># 打印None</span></span><br><span class="line">print(book_obj.authors.all())	<span class="comment"># 成功修改</span></span><br></pre></td></tr></table></figure><p>add</p><ul><li><p>添加多对多关系（不在用列表了）</p></li><li><p>add(id, id)</p></li><li><p>add(对象, 对象)</p></li><li><p>add( *QuerySet) 列表打散</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">book_obj = models.Book.objects.all().first()</span><br><span class="line">print(book_obj.authors.all())</span><br><span class="line"><span class="comment"># 通过 id 添加</span></span><br><span class="line">book_obj.authors.add(<span class="number">1</span>, <span class="number">3</span>)	<span class="comment"># 这里不再是列表了</span></span><br><span class="line">print(book_obj.authors.all())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打散QuerySet添加</span></span><br><span class="line">print(book_obj.authors.all())</span><br><span class="line">book_obj.authors.add(*models.Author.objects.filter(pk__in=[<span class="number">1</span>,<span class="number">3</span>]))</span><br><span class="line">print(book_obj.authors.all())</span><br></pre></td></tr></table></figure><p>remove</p><ul><li>删除多对多关系 (有则删除，无则不变，不会报错)</li><li>remove(id, id)</li><li>remove(对象, 对象)</li><li>remove( *QuerySet) 列表打散</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">book_obj = models.Book.objects.all().first()</span><br><span class="line">print(book_obj.authors.all())</span><br><span class="line">book_obj.authors.remove(<span class="number">1</span>)</span><br><span class="line">print(book_obj.authors.all())</span><br></pre></td></tr></table></figure><p>clear</p><ul><li><p>清空多对多关系</p></li><li><p>对象.关系管理对象.clear()</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">book_obj = models.Book.objects.all().first()</span><br><span class="line">print(book_obj.authors.all())</span><br><span class="line">book_obj.authors.clear()</span><br><span class="line">print(book_obj.authors.all())</span><br></pre></td></tr></table></figure><p>create</p><ul><li>新增一个所关联的对象，并且建立多对多的关系(通过作者去造一本书，并自动添加关系)</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 正向  通过作者对象，来创建一本书，并自动添加关系</span></span><br><span class="line">author = models.Author.objects.all().first()</span><br><span class="line">print(author.books.all())</span><br><span class="line">author.books.create(title=<span class="string">'降龙十八掌'</span>, pub_id=<span class="number">2</span>)</span><br><span class="line">print(author.books.all())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 反向  通过书籍对象，创造一个作者，并自动添加关系</span></span><br><span class="line">book_obj = models.Book.objects.all().first()</span><br><span class="line">print(book_obj.authors.all())</span><br><span class="line">book_obj.authors.create(name=<span class="string">'小强'</span>)</span><br><span class="line">print(book_obj.authors.all())</span><br></pre></td></tr></table></figure><h3 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h3><p>对于外键中关于关系管理对象的方法 和 多对多关系中关系管理对象的方法 它们的一个差别在于后者可以直接使用 id 来进行增删查改，而前者只能通过对象。</p><h1 id="聚合查询和分组查询"><a href="#聚合查询和分组查询" class="headerlink" title="聚合查询和分组查询"></a>聚合查询和分组查询</h1><h2 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a>聚合查询</h2><ul><li><p>从 django.db.models 导入聚合函数，这些聚合函数是类</p></li><li><p>aggregate 是终止子句，执行后得到的是一个字典</p></li></ul><p>例子:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Max,Min,Count,Avg,Sum</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.统计书中最高的价格</span></span><br><span class="line">	<span class="comment"># 默认是对 all()的结果进行聚合,all可以省略。</span></span><br><span class="line">ret = models.Book.objects.aggregate(Max(<span class="string">'price'</span>))</span><br><span class="line">print(ret)</span><br><span class="line">	<span class="comment"># 完整写法，</span></span><br><span class="line">ret = models.Book.objects.all().aggregate(max=Max(<span class="string">'price'</span>))</span><br><span class="line">print(ret)</span><br><span class="line">	<span class="comment"># 可以同时查最大，最小，等等。</span></span><br><span class="line">ret = models.Book.objects.aggregate(max=Max(<span class="string">'price'</span>),min=Min(<span class="string">'price'</span>))</span><br><span class="line">print(ret)</span><br><span class="line">    <span class="comment"># 也可以对筛选后的结果进行聚合，下面两个语句sql语句是一样的。</span></span><br><span class="line">ret = models.Book.objects.filter(pk__range=[<span class="number">3</span>,<span class="number">5</span>]).aggregate(max=Max(<span class="string">'price'</span>),min=Min(<span class="string">'price'</span>))</span><br><span class="line">print(ret)</span><br><span class="line">ret = models.Book.objects.filter(pk__range=[<span class="number">3</span>,<span class="number">5</span>]).values().aggregate(max=Max(<span class="string">'price'</span>),min=Min(<span class="string">'price'</span>))</span><br><span class="line">print(ret)</span><br></pre></td></tr></table></figure><h2 id="分组查询"><a href="#分组查询" class="headerlink" title="分组查询"></a>分组查询</h2><ul><li>分组查询需要和聚合一起使用，不然没多大意义</li><li>annotate 是<strong>注释</strong>的意思（额外添加信息），将结果封装对象的属性，翻译成sql语句，里面是有group by的。</li><li>annotate 默认以该对象的id，进行分组，如果想更改分组条件，可以先使用values进行筛选，然后使用annotate，添加注释。 见例中方法二。 当然使用values筛选建议筛选这个类（表）</li></ul><p>例子:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 统计每一本书的作者个数</span></span><br><span class="line">	<span class="comment"># 使用annotate后给对象添加一个新属性，authors__count</span></span><br><span class="line">ret = models.Book.objects.annotate(Count(<span class="string">'authors'</span>))</span><br><span class="line">ret = models.Book.objects.annotate(Count(<span class="string">'authors'</span>)).values()</span><br><span class="line">print(ret)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ret:</span><br><span class="line">    print(i)	</span><br><span class="line">    <span class="comment"># print(i['authors__count'])</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 统计出每个出版社最便宜的书</span></span><br><span class="line">	<span class="comment"># 方法一： (按出版社进行分组) （一个出版社对应多本书，从少的一方）</span></span><br><span class="line">ret = models.Publisher.objects.annotate(Min(<span class="string">'book__price'</span>))</span><br><span class="line">ret = models.Publisher.objects.values().annotate(Min(<span class="string">'book__price'</span>)).values()   <span class="comment"># 加了values 会更清晰</span></span><br><span class="line">print(ret)</span><br><span class="line">	<span class="comment"># 方法二：（从多的一方入手）</span></span><br><span class="line">ret = models.Book.objects.values(<span class="string">'pub__name'</span>).annotate(Min(<span class="string">'price'</span>))</span><br><span class="line">ret = models.Book.objects.values(<span class="string">'pub__name'</span>).annotate(Min(<span class="string">'price'</span>)).values(<span class="string">'title'</span>)  <span class="comment"># 不再前面出现的字段，如.values('title')，会作为一个新的分组条件（sql语句中）</span></span><br><span class="line">ret = models.Book.objects.values(<span class="string">'pub__name'</span>).annotate(Min(<span class="string">'price'</span>)).values(<span class="string">'price'</span>)  <span class="comment"># 前面出现的字段，做筛选，不会作为新的分组条件</span></span><br><span class="line">print(ret)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 统计不止一个作者图书</span></span><br><span class="line">ret = models.Book.objects.annotate(count=Count(<span class="string">'authors'</span>)).filter(count__gt=<span class="number">1</span>).values()</span><br><span class="line">print(ret)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询各个作者出的书的总价格</span></span><br><span class="line">ret = models.Author.objects.annotate(sum=Sum(<span class="string">'books__price'</span>)).values()</span><br><span class="line">print(ret)</span><br></pre></td></tr></table></figure><h1 id="F查询与Q查询"><a href="#F查询与Q查询" class="headerlink" title="F查询与Q查询"></a>F查询与Q查询</h1><p>F查询：字段之间的比较；动态获取字段的值。</p><p>Q查询是为了弥补 OR</p><h2 id="模型定义-2"><a href="#模型定义-2" class="headerlink" title="模型定义"></a>模型定义</h2><p>为了丰富查询，增加列</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    price = models.DecimalField(max_digits=<span class="number">5</span>,decimal_places=<span class="number">2</span>,default=<span class="number">5</span>)</span><br><span class="line">    sale = models.IntegerField()</span><br><span class="line">    memo = models.IntegerField()</span><br><span class="line">    pub = models.ForeignKey(to=<span class="string">'Publisher'</span>,null=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"<span class="subst">&#123;self.pk&#125;</span>  <span class="subst">&#123;self.title&#125;</span>"</span></span><br></pre></td></tr></table></figure><h2 id="F查询"><a href="#F查询" class="headerlink" title="F查询"></a>F查询</h2><h3 id="字段之间的比较"><a href="#字段之间的比较" class="headerlink" title="字段之间的比较"></a>字段之间的比较</h3><p>以前在filter内写多个条件，用逗号隔开，这是与的意思。</p><p>例如：</p><p>我们查询销量大于50且库存大于30的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ret = models.Book.objects.filter(sale__gt=<span class="number">50</span>, memo__gt=<span class="number">30</span>)   <span class="comment"># sale &gt;50 且 memo &gt; 30</span></span><br><span class="line">print(ret)</span><br></pre></td></tr></table></figure><p>如果我们想查销量大于库存的行有哪些（同一行的不同字段间的比较），通过以前的方式是做不了的，所以引入F查询</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> F</span><br><span class="line"></span><br><span class="line">ret = models.Book.objects.filter(sale__gt=F(<span class="string">'memo'</span>))</span><br><span class="line">print(ret)</span><br></pre></td></tr></table></figure><h3 id="动态获取字段的值"><a href="#动态获取字段的值" class="headerlink" title="动态获取字段的值"></a>动态获取字段的值</h3><p>假如我们想刷一下销量，按照以前的做法，可以这样做：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ret = models.Book.objects.all()</span><br><span class="line"><span class="keyword">for</span> book <span class="keyword">in</span> ret:</span><br><span class="line">    book.sale += <span class="number">10</span></span><br><span class="line">    book.save()</span><br></pre></td></tr></table></figure><ul><li>logging打印的sql语句：</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">0.001</span>) UPDATE `app01_book` SET `title` = <span class="string">'祥龙宝典'</span>, `price` = <span class="string">'5.00'</span>, `sale` = <span class="number">400</span>, `memo` = <span class="number">50</span>, `pub_id` = <span class="number">1</span> WHERE `app01_book`.`id` = <span class="number">7</span>; args=(<span class="string">'祥龙宝典'</span>, <span class="string">'5.00'</span>, <span class="number">400</span>, <span class="number">50</span>, <span class="number">1</span>, <span class="number">7</span>)</span><br><span class="line">(<span class="number">0.001</span>) UPDATE `app01_book` SET `title` = <span class="string">'万象森罗'</span>, `price` = <span class="string">'5.00'</span>, `sale` = <span class="number">400</span>, `memo` = <span class="number">50</span>, `pub_id` = <span class="number">3</span> WHERE `app01_book`.`id` = <span class="number">9</span>; args=(<span class="string">'万象森罗'</span>, <span class="string">'5.00'</span>, <span class="number">400</span>, <span class="number">50</span>, <span class="number">3</span>, <span class="number">9</span>)</span><br></pre></td></tr></table></figure><p>使用F查询就很简单</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ret = models.Book.objects.update(sale=F(<span class="string">'sale'</span>) * <span class="number">2</span> + <span class="number">10</span>)</span><br><span class="line">print(ret)</span><br></pre></td></tr></table></figure><ul><li>logging打印的sql语句</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">0.001</span>) UPDATE `app01_book` SET `sale` = ((`app01_book`.`sale` * <span class="number">2</span>) + <span class="number">10</span>); args=(<span class="number">2</span>, <span class="number">10</span>)</span><br></pre></td></tr></table></figure><p>update与save比较：</p><p>save会把所有内容取出重新赋值，而update只会把需要修改的内容进行修改，效率上，这两个差异很大。</p><h2 id="Q查询"><a href="#Q查询" class="headerlink" title="Q查询"></a>Q查询</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 取 2&lt; pk &lt; 5</span></span><br><span class="line">ret = models.Book.objects.filter(pk__gt=<span class="number">2</span>, pk__lt=<span class="number">5</span>) </span><br><span class="line"><span class="comment"># 那么如果是小于2或大于5呢？ exclue 能解决，但有些复杂了</span></span><br><span class="line">ret = models.Book.objects.exclude(pk__gte=<span class="number">2</span>, pk__lte=<span class="number">5</span>)</span><br></pre></td></tr></table></figure><p>引入Q查询，来解决 OR</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q</span><br><span class="line"></span><br><span class="line">ret = models.Book.objects.filter(Q(pk__gt=<span class="number">5</span>) | Q(pk__lt=<span class="number">2</span>))  <span class="comment"># &gt;5 或 &lt;2</span></span><br><span class="line">print(ret)</span><br><span class="line">ret = models.Book.objects.filter(~Q(pk__gt=<span class="number">5</span>) | Q(pk__lt=<span class="number">2</span>))  <span class="comment"># &lt;=5  或 &lt;2</span></span><br><span class="line">ret = models.Book.objects.filter(~Q(~Q(pk__gt=<span class="number">5</span>) | Q(pk__lt=<span class="number">2</span>)))  <span class="comment"># &gt;5</span></span><br></pre></td></tr></table></figure><p>几种清空：</p><ul><li><p>Q(条件)</p></li><li><p>Q(条件)&amp;Q(条件) 与</p></li><li><p>Q(条件)|Q(条件) 或</p></li><li><p>~Q(条件) 非</p></li></ul><h3 id="Q对象的新写法"><a href="#Q对象的新写法" class="headerlink" title="Q对象的新写法"></a>Q对象的新写法</h3><p>当我们使用搜索功能时，希望对搜索条件有一个更好的封装，而不是直接写一堆Q()</p><ul><li>小试牛刀</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">q = Q()</span><br><span class="line">q.connector = <span class="string">'OR'</span>  <span class="comment"># 里面的内容是或的关系</span></span><br><span class="line">q.children.append(Q(qq__contains=search))			<span class="comment"># 以前这样写</span></span><br><span class="line">q.children.append(Q((<span class="string">'qq_name__contains'</span>,search)))  <span class="comment"># 这里还需要括号包一层，这样的话不再是关键字参数，我们就可以进行变量的拼接</span></span><br><span class="line">print(q)</span><br><span class="line">query = models.Customer.objects.filter(q)</span><br><span class="line">print(query)</span><br></pre></td></tr></table></figure><ul><li>整理简化</li></ul><p>定义：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">local_search</span><span class="params">(self, field_list, search)</span>:</span></span><br><span class="line">    q = Q()</span><br><span class="line">    q.connector = <span class="string">'OR'</span></span><br><span class="line">    <span class="keyword">for</span> field <span class="keyword">in</span> field_list:</span><br><span class="line">        q.children.append(Q((<span class="string">f'<span class="subst">&#123;field&#125;</span>__contains'</span>, search)))</span><br><span class="line">        <span class="comment"># print(q)</span></span><br><span class="line">    <span class="keyword">return</span> q</span><br></pre></td></tr></table></figure><p>使用：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">search = request.GET.get(<span class="string">'local_search'</span>, <span class="string">''</span>)</span><br><span class="line">field_list = [<span class="string">'qq_name'</span>, <span class="string">'phone'</span>, <span class="string">'name'</span>, <span class="string">'qq'</span>]</span><br><span class="line">q = self.local_search(field_list, search)</span><br></pre></td></tr></table></figure><h1 id="bulk-create"><a href="#bulk-create" class="headerlink" title="bulk_create"></a>bulk_create</h1><p>一次性插入多条</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 批量插入数据</span></span><br><span class="line"><span class="comment"># 内存中生成</span></span><br><span class="line">studyrecords_list = []</span><br><span class="line">studyrecords_list.append(实例化)</span><br><span class="line"><span class="comment"># 使用bulk_create批量插入</span></span><br><span class="line">models.StudyRecord.object.bulk_create(studyrecords_list)  <span class="comment"># 批量插入</span></span><br></pre></td></tr></table></figure><h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><p>一系列操作，当作一个操作。要么都成功，要么都失败。</p><p>格式：</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">with transation.atomic<span class="params">()</span>:</span><br><span class="line">    <span class="comment"># 设置事务回滚的标记点</span></span><br><span class="line">    sid1 = transation.savepoint<span class="params">()</span></span><br><span class="line"></span><br><span class="line">    <span class="string">....</span> <span class="comment"># 增删改等数据库操作</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">    <span class="string">....</span></span><br><span class="line">    except:</span><br><span class="line">    transation.savepoint_rallback<span class="params">(sid1)</span></span><br></pre></td></tr></table></figure><p>例1：</p><p>a同学给b同学转账100元</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">rom django.db <span class="keyword">import</span> transaction</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> transaction.atomic():</span><br><span class="line">        <span class="comment"># orm 操作</span></span><br><span class="line">        a = models.People.objects.filter(pk=<span class="number">2</span>).select_for_update()</span><br><span class="line">        b = models.People.objects.filter(pk=<span class="number">3</span>).select_for_update()       </span><br><span class="line">        <span class="keyword">if</span> a.account<span class="number">-100</span> &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception</span><br><span class="line">        a.account -= <span class="number">100</span></span><br><span class="line">        a.save()</span><br><span class="line">        <span class="comment"># int('ssss')</span></span><br><span class="line">        b.account += <span class="number">100</span></span><br><span class="line">        b.save()</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    print(e)</span><br></pre></td></tr></table></figure><ul><li><p><code>with transaction.atomic()</code> 开启事务</p></li><li><p><code>.select_for_update()</code> 开启行级锁</p></li></ul><h1 id="执行原生SQL"><a href="#执行原生SQL" class="headerlink" title="执行原生SQL"></a>执行原生SQL</h1><p>例子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> connection, connections</span><br><span class="line">cursor = connection.cursor()  <span class="comment"># cursor = connections['default'].cursor()</span></span><br><span class="line">cursor.execute(<span class="string">"""SELECT * from app01_person where pid = %s"""</span>, [<span class="number">1</span>])</span><br><span class="line">row = cursor.fetchone()</span><br><span class="line">print(row)</span><br></pre></td></tr></table></figure><h1 id="小结-3"><a href="#小结-3" class="headerlink" title="小结"></a>小结</h1><ol><li><p>写orm语句的时候，可以正向，可以反向，根据要求中出现的表名出发，两种写出来进行比较。</p></li><li><p>正向查询后继续反向回查会多连一次表。例子如下：</p></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查找书名是“小灰机”的书的出版社出版的其他书籍的名字和价格</span></span><br><span class="line">ret = models.Book.objects.filter(publisher__book__title=<span class="string">'小灰机'</span>).exclude(title=<span class="string">'小灰机'</span>)</span><br><span class="line"><span class="comment"># 从book 到 publisher 在回到 book </span></span><br><span class="line"><span class="comment"># 在sql语句中是 将book表与publisher进行内连接，在与book表进行内连接。</span></span><br></pre></td></tr></table></figure><ol start="3"><li><p>先values在filter 与 先filter在values是不一样的</p><ul><li><p>先filter在values，这样列少一些（少一些连表），信息会缺。</p></li><li><p>先filter在values，先增加列信息，然后再进行筛选，这也不会缺失信息。（这个作者它的所有书籍都在一行，而不是一本书是一条行）</p></li></ul></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查找书名是“小灰机”的书的作者们的姓名以及出版的所有书籍名称和价钱 </span></span><br><span class="line"><span class="comment"># orm语句</span></span><br><span class="line">ret = models.Author.objects.filter(book__title=<span class="string">'小灰机'</span>).values(<span class="string">'name'</span>, <span class="string">'book__title'</span>, <span class="string">'book__price'</span>)</span><br><span class="line">print(ret)</span><br><span class="line"><span class="comment"># 打印的sql语句</span></span><br><span class="line">SELECT `app01_author`.`name`, `app01_book`.`title`, `app01_book`.`price`</span><br><span class="line">FROM `app01_author` INNER JOIN `app01_book_author` ON (`app01_author`.`id` = `app01_book_author`.`author_id`)</span><br><span class="line">                    INNER JOIN `app01_book` ON (`app01_book_author`.`book_id` = `app01_book`.`id`)</span><br><span class="line">WHERE `app01_book`.`title` = <span class="string">'小灰机'</span> LIMIT <span class="number">21</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># orm语句</span></span><br><span class="line">ret = models.Author.objects.values(<span class="string">'name'</span>, <span class="string">'book__title'</span>, <span class="string">'book__price'</span>).filter(book__title=<span class="string">'小灰机'</span>)</span><br><span class="line">print(ret)</span><br><span class="line"><span class="comment"># 打印的sql语句</span></span><br><span class="line">SELECT `app01_author`.`name`, `app01_book`.`title`, `app01_book`.`price`</span><br><span class="line">FROM `app01_author` LEFT OUTER JOIN `app01_book_author` ON (`app01_author`.`id` = `app01_book_author`.`author_id`)</span><br><span class="line">                    LEFT OUTER JOIN `app01_book` ON (`app01_book_author`.`book_id` = `app01_book`.`id`)</span><br><span class="line">                    INNER JOIN `app01_book_author` T4 ON (`app01_author`.`id` = T4.`author_id`)</span><br><span class="line">                    INNER JOIN `app01_book` T5 ON (T4.`book_id` = T5.`id`)</span><br><span class="line">WHERE T5.`title` = <span class="string">'小灰机'</span> LIMIT <span class="number">21</span>;</span><br></pre></td></tr></table></figure><ol start="4"><li>null 和 空 的判断方式是不一样的，但对于查一个字段是否为空，需要将两者结合</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查找memo字段是空的书 </span></span><br><span class="line">ret = models.Book.objects.filter(Q(memo__isnull=<span class="literal">True</span>) | Q(memo=<span class="string">''</span>))</span><br><span class="line">print(ret)</span><br></pre></td></tr></table></figure></div><div><div><div style="text-align:center;color:#555;font-size:14px">-------------The End-------------</div></div></div><div><div class="my_post_copyright"><script src="/js/src/clipboard.min.js"></script><script src="/js/src/jquery2.0/jquery.min.js"></script><script src="/js/src/sweetalert.min.js"></script><p><span>本文标题:</span><a href="/django/20190707-django_7_orm.html">Django的ORM</a></p><p><span>文章作者:</span><a href="/" title="访问 Naqin 的个人博客">Naqin</a></p><p><span>发布时间:</span>2019年07月07日 - 21:07</p><p><span>最后更新:</span>2019年11月15日 - 19:11</p><p><span>原始链接:</span><a href="/django/20190707-django_7_orm.html" title="Django的ORM">https://chennq.com/django/20190707-django_7_orm.html</a> <span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://chennq.com/django/20190707-django_7_orm.html" aria-label="复制成功！"></i></span></p><p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p></div><script>var clipboard=new Clipboard(".fa-clipboard");$(".fa-clipboard").click(function(){clipboard.on("success",function(){swal({title:"",text:"复制成功",icon:"success",showConfirmButton:!0})})})</script></div><div><div id="wechat_subscriber" style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"><img id="wechat_subscriber_qcode" src="/uploads/wechat.jpg" alt="Naqin wechat" style="width:200px;max-width:100%"><div>欢迎看官加我微信！</div></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>坚持原创技术分享，您的支持将鼓励我继续创作！</div><button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'><span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="/uploads/wechatpay.jpg" alt="Naqin 微信支付"><p>微信支付</p></div></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/django/" rel="tag"><i class="fa fa-tag"></i> django</a> <a href="/tags/学习笔记/" rel="tag"><i class="fa fa-tag"></i> 学习笔记</a> <a href="/tags/Web前端/" rel="tag"><i class="fa fa-tag"></i> Web前端</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/Pytorch学习笔记/20190707-learning_PyTorch_11_gradient.html" rel="next" title="Pytorch-激活函数与Loss的梯度"><i class="fa fa-chevron-left"></i> Pytorch-激活函数与Loss的梯度</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/django/20190709-django_8_cookie_session.html" rel="prev" title="Django的cookie与session">Django的cookie与session <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div id="gitalk-container"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="https://schema.org/Person"><img class="site-author-image" itemprop="image" src="/uploads/tu6.jpg" alt="Naqin"><p class="site-author-name" itemprop="name">Naqin</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">118</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">28</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">39</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/atlasnq" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:1121559571@qq.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ORM"><span class="nav-number">1.</span> <span class="nav-text">ORM</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#是什么"><span class="nav-number">1.1.</span> <span class="nav-text">是什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优势"><span class="nav-number">1.2.</span> <span class="nav-text">优势</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#劣势"><span class="nav-number">1.3.</span> <span class="nav-text">劣势</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Django的ORM"><span class="nav-number">1.4.</span> <span class="nav-text">Django的ORM</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试方式"><span class="nav-number">1.5.</span> <span class="nav-text">测试方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#console控制台"><span class="nav-number">1.5.1.</span> <span class="nav-text">console控制台</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义py文件"><span class="nav-number">1.5.2.</span> <span class="nav-text">自定义py文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#admin管理后台"><span class="nav-number">1.5.3.</span> <span class="nav-text">admin管理后台</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#打印sql语句"><span class="nav-number">1.5.4.</span> <span class="nav-text">打印sql语句</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#字段"><span class="nav-number">2.</span> <span class="nav-text">字段</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#常用字段"><span class="nav-number">2.1.</span> <span class="nav-text">常用字段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数值"><span class="nav-number">2.1.1.</span> <span class="nav-text">数值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#布尔值"><span class="nav-number">2.1.2.</span> <span class="nav-text">布尔值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字符"><span class="nav-number">2.1.3.</span> <span class="nav-text">字符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#时间"><span class="nav-number">2.1.4.</span> <span class="nav-text">时间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证"><span class="nav-number">2.1.5.</span> <span class="nav-text">验证</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义字段"><span class="nav-number">2.2.</span> <span class="nav-text">自定义字段</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#字段参数"><span class="nav-number">3.</span> <span class="nav-text">字段参数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#常用参数"><span class="nav-number">3.1.</span> <span class="nav-text">常用参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#model-form-系列"><span class="nav-number">3.2.</span> <span class="nav-text">model form 系列</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Model-Meta参数"><span class="nav-number">3.3.</span> <span class="nav-text">Model Meta参数</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Manager"><span class="nav-number">4.</span> <span class="nav-text">Manager</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#更改Manager对象的名称"><span class="nav-number">4.1.</span> <span class="nav-text">更改Manager对象的名称</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义Manager对象"><span class="nav-number">4.2.</span> <span class="nav-text">自定义Manager对象</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#QuerySet"><span class="nav-number">5.</span> <span class="nav-text">QuerySet</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#限制QuerySet"><span class="nav-number">5.1.</span> <span class="nav-text">限制QuerySet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lazy-load"><span class="nav-number">5.2.</span> <span class="nav-text">Lazy load</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#缓存"><span class="nav-number">5.3.</span> <span class="nav-text">缓存</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#必知必会13条（查询）"><span class="nav-number">6.</span> <span class="nav-text">必知必会13条（查询）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#返回QuerySet"><span class="nav-number">6.1.</span> <span class="nav-text">返回QuerySet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#返回对象"><span class="nav-number">6.2.</span> <span class="nav-text">返回对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#返回bool"><span class="nav-number">6.3.</span> <span class="nav-text">返回bool</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#返回数字"><span class="nav-number">6.4.</span> <span class="nav-text">返回数字</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#单表的双下划线"><span class="nav-number">7.</span> <span class="nav-text">单表的双下划线</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#范围"><span class="nav-number">7.1.</span> <span class="nav-text">范围</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#大于，大于等于，小于，小于等于"><span class="nav-number">7.1.1.</span> <span class="nav-text">大于，大于等于，小于，小于等于</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#具体区间"><span class="nav-number">7.1.2.</span> <span class="nav-text">具体区间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#成员判断"><span class="nav-number">7.1.3.</span> <span class="nav-text">成员判断</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模糊查询"><span class="nav-number">7.2.</span> <span class="nav-text">模糊查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#包含"><span class="nav-number">7.2.1.</span> <span class="nav-text">包含</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#以什么开头"><span class="nav-number">7.2.2.</span> <span class="nav-text">以什么开头</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#以什么结尾"><span class="nav-number">7.2.3.</span> <span class="nav-text">以什么结尾</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#年份"><span class="nav-number">7.2.4.</span> <span class="nav-text">年份</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为空"><span class="nav-number">7.2.5.</span> <span class="nav-text">为空</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#外键的查询"><span class="nav-number">8.</span> <span class="nav-text">外键的查询</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#模型定义"><span class="nav-number">8.1.</span> <span class="nav-text">模型定义</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#自关联"><span class="nav-number">8.1.1.</span> <span class="nav-text">自关联</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#伪外键"><span class="nav-number">8.1.2.</span> <span class="nav-text">伪外键</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基于对象的查询"><span class="nav-number">8.2.</span> <span class="nav-text">基于对象的查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#不指定related-name"><span class="nav-number">8.2.1.</span> <span class="nav-text">不指定related_name</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#指定related-name"><span class="nav-number">8.2.2.</span> <span class="nav-text">指定related_name</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基于字段的查询"><span class="nav-number">8.3.</span> <span class="nav-text">基于字段的查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#不指定related-name-1"><span class="nav-number">8.3.1.</span> <span class="nav-text">不指定related_name</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#指定related-name-1"><span class="nav-number">8.3.2.</span> <span class="nav-text">指定related_name</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#指定related-query-name"><span class="nav-number">8.3.3.</span> <span class="nav-text">指定related_query_name</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结"><span class="nav-number">8.3.4.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关系管理对象的方法"><span class="nav-number">8.4.</span> <span class="nav-text">关系管理对象的方法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#多对多关系"><span class="nav-number">9.</span> <span class="nav-text">多对多关系</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#模型定义-1"><span class="nav-number">9.1.</span> <span class="nav-text">模型定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基于对象的查询-1"><span class="nav-number">9.2.</span> <span class="nav-text">基于对象的查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#不指定related-name-2"><span class="nav-number">9.2.1.</span> <span class="nav-text">不指定related_name</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#指定related-name-2"><span class="nav-number">9.2.2.</span> <span class="nav-text">指定related_name</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基于字段的查询-1"><span class="nav-number">9.3.</span> <span class="nav-text">基于字段的查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#不指定related-name-3"><span class="nav-number">9.3.1.</span> <span class="nav-text">不指定related_name</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#指定related-name-3"><span class="nav-number">9.3.2.</span> <span class="nav-text">指定related_name</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结-1"><span class="nav-number">9.3.3.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关系管理对象的方法-1"><span class="nav-number">9.4.</span> <span class="nav-text">关系管理对象的方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#小结-2"><span class="nav-number">9.4.1.</span> <span class="nav-text">小结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#聚合查询和分组查询"><span class="nav-number">10.</span> <span class="nav-text">聚合查询和分组查询</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#聚合查询"><span class="nav-number">10.1.</span> <span class="nav-text">聚合查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分组查询"><span class="nav-number">10.2.</span> <span class="nav-text">分组查询</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#F查询与Q查询"><span class="nav-number">11.</span> <span class="nav-text">F查询与Q查询</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#模型定义-2"><span class="nav-number">11.1.</span> <span class="nav-text">模型定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#F查询"><span class="nav-number">11.2.</span> <span class="nav-text">F查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#字段之间的比较"><span class="nav-number">11.2.1.</span> <span class="nav-text">字段之间的比较</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态获取字段的值"><span class="nav-number">11.2.2.</span> <span class="nav-text">动态获取字段的值</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Q查询"><span class="nav-number">11.3.</span> <span class="nav-text">Q查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Q对象的新写法"><span class="nav-number">11.3.1.</span> <span class="nav-text">Q对象的新写法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#bulk-create"><span class="nav-number">12.</span> <span class="nav-text">bulk_create</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#事务"><span class="nav-number">13.</span> <span class="nav-text">事务</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#执行原生SQL"><span class="nav-number">14.</span> <span class="nav-text">执行原生SQL</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#小结-3"><span class="nav-number">15.</span> <span class="nav-text">小结</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span> <span class="with-love"><i class="fa fa-heartbeat"></i> </span><span class="author" itemprop="copyrightHolder">Naqin</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv">本站总访客 <span class="busuanzi-value" id="busuanzi_value_site_uv"></span> 人 </span><span class="site-pv">本站总访问 <span class="busuanzi-value" id="busuanzi_value_site_pv"></span> 次</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><link rel="stylesheet" href="/css/gitalk.css"><script src="/js/src/gitalk.min.js"></script><div id="gitalk-container"></div><script src="/js/src/md5.min.js"></script><script type="text/javascript">var gitalk=new Gitalk({clientID:"377dab7c4f5a8991f28c",clientSecret:"7440711408c01caf520bc000a5a353aef73a142b",repo:"guestbook",owner:"atlasnq",admin:["atlasnq"],id:md5(location.pathname),distractionFreeMode:"true"});gitalk.render("gitalk-container")</script><script type="text/javascript">// Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script></body></html>